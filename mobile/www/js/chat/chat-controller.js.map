{"version":3,"names":[],"mappings":"","sources":["chat/chat-controller.js"],"sourcesContent":["(function () {\n  'use strict';\n\n  /**\n   * @ngdoc object\n   * @name chat.controller:ChatCtrl\n   *\n   * @description\n   *\n   */\n  angular\n    .module('chat')\n    .controller('ChatCtrl', ChatCtrl);\n\n  function ChatCtrl($rootScope, $timeout, $state, $ionicScrollDelegate, $ionicSideMenuDelegate, $filter, ChatService) {\n\n    var self = this;\n\n    this.typing\n\n    this.tempUser = JSON.parse(localStorage['auth_user'])\n\n    this.cod = $rootScope.auth_user ? $rootScope.auth_user.cod : self.tempUser.cod\n\n    this.auth_nick = $rootScope.auth_user ? $rootScope.auth_user.nick : self.tempUser.nick\n\n    this.id_user = $state.params.id_user;\n\n    this.nick = $state.params.nick;\n\n    ChatService.createChat(\n      {\n        us: self.id_user, \n        cod: self.cod\n      },\n      function (response){\n        console.log(response)\n\n        ChatService.open.set(response.id);\n\n        self.backgroundImage = response.data.optChat[0].bg\n\n      }\n    )\n\n    ChatService.loadMessages(\n      {\n        \n        cod: self.cod, \n        \n        nick: self.nick, \n\n        id_user: self.id_user\n\n      },\n\n      function (messages){\n\n        var filter\n\n        $rootScope.messages[self.nick] = messages;\n        \n        filter = $filter('filter')($rootScope.messages[self.nick], {id_inicia: self.id_user})\n\n        $rootScope.tempChatImages[self.nick] = filter[filter.length-1].pDir\n\n        $timeout(function () {\n\n          $ionicScrollDelegate.$getByHandle('chatScroll').scrollBottom(true);\n\n        })\n    \n    });\n\n\n    $rootScope.chatificator.on('typing' + self.cod, function(a){\n\n        if (angular.equals(a, self.id_user))\n          self.workTyping()\n\n    })\n\n    this.workTyping = function(){\n\n      self.scrollToBottom()\n      if(self.typing){\n\n      var msgTag=document.querySelector('li.typing');\n        msgTag.dataset.hide=0;\n        /*self.showTyping = true*/\n\n        $timeout.cancel(self.typing);\n\n      }\n        \n      self.typing = $timeout(function(){\n        var msgTag=document.querySelector('li.typing');\n        msgTag.dataset.hide=1;\n        //self.showTyping = false\n\n        //self.scrollToBottom()\n        \n      },1000);\n    }\n\n    this.emitTyping = function(){\n\n        ChatService.typing({me: self.cod, you: self.id_user })\n      \n\n    }\n\n    this.scrollToBottom = function(){\n\n      $timeout(function () {\n\n          $ionicScrollDelegate.$getByHandle('chatScroll').scrollBottom(true);\n\n        })\n\n    }\n\n\n    this.sendMessage = function () {\n\n      if (self.message === '' || self.message === null) return;\n\n      $rootScope.chatificator.emit('mgss', {\n\n        usaer: '587458125487' + self.id_user,\n\n        me: {\n\n          nick: self.auth_nick,\n\n          user: self.cod\n\n        },\n\n        mens: self.message\n\n      }, function (msg) {\n\n        $rootScope.messages[self.nick].push(msg);\n\n        self.message = '';\n\n        $ionicScrollDelegate.$getByHandle('chatScroll').scrollBottom(true);\n\n      });\n\n    };\n\n  }\n\n}());\n"],"file":"chat/chat-controller.js","sourceRoot":"/source/"}
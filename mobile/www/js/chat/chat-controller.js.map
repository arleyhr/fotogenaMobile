{"version":3,"names":[],"mappings":"","sources":["chat/chat-controller.js"],"sourcesContent":["(function () {\r\n  'use strict';\r\n\r\n  /**\r\n   * @ngdoc object\r\n   * @name chat.controller:ChatCtrl\r\n   *\r\n   * @description\r\n   *\r\n   */\r\n  angular\r\n    .module('chat')\r\n    .controller('ChatCtrl', ChatCtrl);\r\n\r\n    \r\n\r\n  function ChatCtrl($rootScope, $timeout, $state, $ionicScrollDelegate, $ionicSideMenuDelegate, $filter, ChatService) {\r\n\r\n    var self = this;\r\n\r\n    var textarea = angular.element(document.querySelector('textarea'));\r\n\r\n    var messages_box = angular.element(document.querySelector('.messages'))\r\n\r\n\r\n    this.keepKeyboardOpen = function () {\r\n\r\n      textarea.one('blur', function() {\r\n\r\n        textarea[0].focus();\r\n\r\n      });\r\n    }\r\n\r\n\r\n    this.typing\r\n\r\n    this.tempUser = JSON.parse(localStorage['auth_user'])\r\n\r\n    this.cod = $rootScope.auth_user ? $rootScope.auth_user.cod : self.tempUser.cod\r\n\r\n    this.auth_nick = $rootScope.auth_user ? $rootScope.auth_user.nick : self.tempUser.nick\r\n\r\n    this.id_user = $state.params.id_user;\r\n\r\n    this.nick = $state.params.nick;\r\n\r\n// { chat: 'user_273', user: '54871', nick: 'SonickSeven' }\r\n    // $rootScope.chatificator.emit('chatCreate',{\r\n    //     iChat: $state.params.iChat,\r\n    //     uss: self.id_user,\r\n    //     me: self.cod\r\n    //   },function(data){\r\n    //     console.log('hey!')\r\n    //     console.log(data)\r\n    //\r\n    //     $rootScope.messages[data.id] = data.data.msg\r\n    //\r\n    // })\r\n\r\n    $rootScope.chatificator.emit('chatCreate',{ chat: 'user_'+self.id_user, user: self.cod, nick: self.nick },function(data){\r\n        console.log('hey!')\r\n        console.log(data)\r\n\r\n        $rootScope.messages[data.id] = data.data.msg\r\n\r\n        self.idChat = data.id\r\n\r\n        self.backgroundImage = data.uss.bDir\r\n\r\n        self.scrollToBottom()\r\n\r\n    })\r\n\r\n    // ChatService.createChat(\r\n    //   {\r\n    //     iChat: $state.params.iChat,\r\n    //     uss: self.id_user,\r\n    //     me: self.cod\r\n    //   },\r\n    //   function (response){\r\n    //     console.log(response)\r\n    //\r\n    //     self.idChat = response.id\r\n    //\r\n    //     ChatService.open.set(response.id);\r\n    //\r\n    //     self.backgroundImage = response.uss.bDir\r\n    //\r\n    //   }\r\n    // )\r\n\r\n//     ChatService.loadMessages(\r\n//       {\r\n//\r\n//         cod: self.cod,\r\n//\r\n//         nick: self.nick,\r\n//\r\n//         id_user: self.id_user\r\n//\r\n//       },\r\n//\r\n//       function (messages){\r\n// console.log(messages)\r\n//         var filter\r\n//\r\n//         $rootScope.messages[self.nick] = messages || [];\r\n//\r\n//         filter = $filter('filter')($rootScope.messages[self.nick], {id_inicia: self.id_user})\r\n//\r\n//         $rootScope.tempChatImages[self.nick] = filter[filter.length-1].pDir\r\n//\r\n//         $timeout(function () {\r\n//\r\n//           $ionicScrollDelegate.$getByHandle('chatScroll').scrollBottom(true);\r\n//\r\n//         })\r\n//\r\n//     });\r\n\r\n    $rootScope.chatificator.on('typing' + self.cod, function(a){\r\n\r\n        if (angular.equals(a, self.id_user))\r\n          self.workTyping()\r\n\r\n    })\r\n\r\n    this.onFocus = function(){\r\n      $timeout(function(){\r\n        messages_box.classList.add('margin_bottom')\r\n      self.scrollToBottom()\r\n    }, 0)\r\n    }\r\n    this.onBlur = function(){\r\n      $timeout(function(){\r\n        messages_box.classList.remove('margin_bottom')\r\n        self.scrollToBottom()\r\n      }, 0)\r\n    }\r\n\r\n    this.workTyping = function(){\r\n\r\n      self.scrollToBottom()\r\n      if(self.typing){\r\n\r\n      var msgTag=document.querySelector('li.typing');\r\n        msgTag.dataset.hide=0;\r\n        /*self.showTyping = true*/\r\n\r\n        $timeout.cancel(self.typing);\r\n\r\n      }\r\n\r\n      self.typing = $timeout(function(){\r\n        var msgTag=document.querySelector('li.typing');\r\n        msgTag.dataset.hide=1;\r\n        //self.showTyping = false\r\n\r\n        //self.scrollToBottom()\r\n\r\n      },1000);\r\n    }\r\n\r\n    this.emitTyping = function(){\r\n\r\n        ChatService.typing({me: self.cod, you: self.id_user })\r\n\r\n\r\n    }\r\n\r\n    this.scrollToBottom = function(){\r\n\r\n      $timeout(function () {\r\n\r\n          $ionicScrollDelegate.$getByHandle('chatScroll').scrollBottom(true);\r\n\r\n        })\r\n\r\n    }\r\n\r\n    console.log($rootScope.openedChats)\r\n\r\n    this.sendMessage = function () {\r\n\r\n      self.keepKeyboardOpen();\r\n\r\n      if (self.message === '' || self.message === null || self.sending || !self.message) return;\r\n\r\n\r\n      self.sending = true\r\n\r\n\r\n      $rootScope.chatificator.emit('mgss', {\r\n\r\n        // usaer: '587458125487' + self.id_user,\r\n\r\n        me: {\r\n\r\n          pDir: $rootScope.auth_user.pDir,\r\n\r\n          nick: self.auth_nick,\r\n\r\n          user: self.cod\r\n\r\n        },\r\n\r\n        chat: self.idChat,\r\n\r\n        device: 1,\r\n\r\n        mens: self.message\r\n\r\n      }, function (msg) {\r\n        console.log(msg)\r\n\r\n\r\n        if (!$rootScope.messages[msg.chat])\r\n          $rootScope.messages[msg.chat] = []\r\n\r\n        $rootScope.messages[msg.chat].push(msg);\r\n        self.message = '';\r\n\r\n        self.sending = false\r\n\r\n        $timeout(function() {\r\n\r\n          self.keepKeyboardOpen();\r\n          self.scrollToBottom()\r\n        }, 0);\r\n\r\n        \r\n\r\n      });\r\n\r\n    };\r\n\r\n  }\r\n\r\n}());\r\n"],"file":"chat/chat-controller.js","sourceRoot":"/source/"}